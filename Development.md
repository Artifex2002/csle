# Developer Guide

## Install development tools

Install the Python build tool
```bash
pip install -q build
```

Install `twine` for publishing packages to PyPi:
```bash
python3 -m pip install --upgrade twine
```

Install the `flake8` linter for Python:
```bash
python -m pip install flake8
```

Install the mypy for static type checking in Python:
```bash
python3 -m pip install -U mypy
```

Install `pytest` and `mock` for Python unit tests:
```bash
pip install -U pytest mock pytest-mock pytest-cov
```

Install ruby and its bundler to generate the documentation page:
```bash
sudo apt-get install ruby ruby-dev
sudo gem install bundler
```

Install Sphinx to automatically generate API documentation from docstrings: 
```bash
pip install sphinx sphinxcontrib-napoleon sphinx-rtd-theme
```

Install tox for automatically running Python tests in different Python environments:
```bash
pip install tox
```

## Static code analysis

### Python:

To run the python linter execute:
 ```bash
./python_linter.sh 
 ```
or:
```bash
flake8 simulation-system/
flake8 csle-cli
flake8 emulation-system/envs
flake8 examples/
```

To run the type checker, execute:
 ```bash
simulation-system/libs/type_checker.sh 
 ```

### JavaScript:
To run the JavaScript linter and print possible errors, use the commands:
```bash
cd management-system/csle-mgmt-webapp/; npm run lint
```
To automatically fix linting errors, use the command:
```bash
cd management-system/csle-mgmt-webapp/; npm run lint:fix
```

## Generate API Documentation

To generate the Python API documentation, run:
```bash
simulation-system/libs/generate_docs.sh
```

## Tests

### Unit tests

#### Python 

The Python unit tests are based on [pytest](https://docs.pytest.org/en/7.2.x/).  To run the Python unit tests, execute:
```bash
simulation-system/libs/unit_tests.sh
```

When adding new unit tests note that:

- All unit tests must be written in a tests/ directory inside the python project
- File names should strictly start with tests_
- Function names should strictly start with test

#### JavaScript
The JavaScript unit tests are based on [jest](https://jestjs.io/).  To run the JavaScript unit tests, execute:
```bash
cd management-system/csle-mgmt-webapp; npm test
```

### Integration tests

To run the integration tests, execute:
```bash
simulation-system/libs/integration_tests.sh
```

## Continuous Integration

## Lines of code

The project consists of aorund 120k lines of Python, 30k lines of JavaScript, 2.5k lines of Dockerfiles, 
1.4k lines of Makefile, and 1.6k lines of bash. 
The lines of code can be counted by executing the following commands from the project root:
``` bash
find . -name '*.py' | xargs wc -l
find . -name '*.js' | xargs wc -l
find . -name 'Dockerfile' | xargs wc -l
find . -name 'Makefile' | xargs wc -l
find . -name '*.sh' | xargs wc -l
```

## Release management

CSLE has semantic versioning, i.e versions of CSLE are of the form `MAJOR.MINOR.PATCH`

1. The MAJOR version is incremented when incompatible API changes are made
2. The MINOR version is incremented new functionality is added in a backwards compatible manner
3. The PATCH version is incremented when backwards compatible bug fixes are made

To generate a new release of CSLE, the following steps must be performed:

1. Publish new versions of the Python libraries to [https://pypi.org/](https://pypi.org/)
2. Publish new versions of the Docker containers to [https://hub.docker.com/](https://hub.docker.com/)
3. Publish a new version of the documentation to (http://limmen.dev/csle)[http://limmen.dev/csle]
4. Make a github release with all artefacts at [https://github.com/Limmen/csle](https://github.com/Limmen/csle)

### Python Releases

To make a new python release, do the following:

1. Edit the `RELEASE_CONFIG` variable in [./simulation-system/libs/make_release.py](./simulation-system/libs/make_release.py) to match the versions of the release.
2. Run: `python ./simulation-system/libs/make_release.py`

### Documentation Releases

After making a new Python release, the new API documentation can be generated by running:

```bash
simulation-system/libs/generate_docs.sh
```

### Docker Releases

To make a new Docker release, do the following:

1. Edit the `VERSION` variable in [./emulation-system/base_images/Makefile](./emulation-system/base_images/Makefile)
2. Edit the `VERSION` variable in [./emulation-system/derived_images/Makefile](./emulation-system/derived_images/Makefile)
3. Build the images (`cd emulation-system/; make build`)
4. Push the images (`cd emulation-system/; make push`)

### GitHub Releases

To make a release in GitHub, follow the guide [here](https://docs.github.com/en/repositories/releasing-projects-on-github/managing-releases-in-a-repository).

## Author & Maintainer

Kim Hammar <kimham@kth.se>

## Copyright and license

[LICENSE](LICENSE.md)

Creative Commons

(C) 2020-2022, Kim Hammar